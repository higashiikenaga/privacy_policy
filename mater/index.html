<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地図に書き込めるSNS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
            background-color: #f0f2f5;
        }
        #app-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* モバイルでは縦並び */
            position: relative; /* オーバーレイの基準点 */
            overflow: hidden; /* 子要素がはみ出さないように */
        }
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* モバイルでは縦並び */
            gap: 1rem; /* gap-4 */
            padding: 1rem; /* p-4 */
            overflow: hidden; /* Ensure content stays within bounds */
        }
        #map-area {
            flex-grow: 1; /* マップが利用可能なスペースを占める */
            width: 100%;
            height: 100%; /* マップエリアの高さを明示的に確保 */
            position: relative;
            z-index: 0; /* マップを最背面に */
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden; /* Ensure map content respects border-radius */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* デスクトップ用タブメニュー */
        #desktop-tabs {
            display: none; /* 初期状態では非表示 */
            justify-content: center;
            margin-bottom: 1rem; /* mb-4 */
            background-color: white;
            z-index: 300;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
        }

        #desktop-tabs button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
            border: none;
            cursor: pointer;
            background-color: transparent;
            color: #4B5563; /* gray-600 */
        }

        #desktop-tabs button.active {
            background-color: #E5E7EB; /* gray-200 */
        }

        #post-form-overlay.active {
            transform: translateY(0%); /* 表示時にスライドアップ */
        }

        /* ユーザー名入力モーダルのスタイル */
        #name-input-modal, #confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* 半透明の黒背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            z-index: 200; /* 最前面に */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }

        #post-form-overlay, #name-input-modal.active, #confirm-modal.active {
            opacity: 1;
            visibility: visible;
        }

        #name-input-modal .modal-content, #confirm-modal .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        /* タイムラインコンテナのスタイル */
        #post-form-overlay, #timeline-container,#account-menu {
            width: 25%; /* デフォルトは全幅 */
            flex-grow: 1;
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            flex-direction: column;
            align-items: flex-start; /* 左寄せ */
            overflow-y: scroll;
            justify-content: flex-start;
            gap: 0.5rem;
            height: 95vh;
            display: none;
            z-index: 100; /* 前面に */
            position: fixed;
                right: 0;
                top: 0;
            flex-direction: column;
        }
        .timeline-tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
            border: none;
            cursor: pointer;
            background-color: transparent;
            color: #4B5563; /* gray-600 */
        }
        .timeline-tab-btn.active {
            background-color: white;
            color: #1F2937; /* gray-800 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
            #timeline-container.active,#account-menu.active {
                position: fixed;
                right: 0;
                top: 0;
                width: 45%;
                display: flex; /* 表示時にはflexコンテナとして */
            }

        #bottom-nav{
            display: flex;
            position: absolute;
            bottom: 0;
            z-index: 300;
        }
        
    </style>
</head>
<body class="flex flex-col h-screen">
    <div id="app-container" class="flex-grow flex-col">
        <!-- メインコンテンツエリア (マップと投稿フォーム/タイムライン) -->
        <div id="main-content">
            <!-- マップエリア -->
            <div id="map-area">
                <div id="map" class="w-full h-full"></div>
            </div>

            <!-- タイムラインコンテナ -->
            <div id="right-sidebar">
                    <div id="timeline-container">
                        <div id="trending-hashtags-container" class="mb-4 p-3 bg-gray-100 rounded-lg">
                                <h3 class="font-bold text-gray-700 mb-2">トレンド</h3>
                                <div id="trending-hashtags-list" class="space-y-1">
                                    <!-- トレンドハッシュタグがここに動的に追加されます -->
                                    <p class="text-sm text-gray-500">トレンドを読み込み中...</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">タイムライン</h2>
                            <div id="timeline-tabs" class="flex space-x-1 bg-gray-200 p-1 rounded-lg">
                                <button class="timeline-tab-btn active" data-tab="all">すべて</button>
                                <button class="timeline-tab-btn" data-tab="following">フォロー中</button>
                            </div>
                        </div>
                        <div id="timeline-posts" class="space-y-4">                            <!-- タイムラインの投稿がここに動的に追加されます -->
                            <p class="text-gray-500 text-center">投稿がありません。</p>
                        </div>
                    </div>
            <!-- 投稿フォームオーバーレイ (モバイルではオーバーレイ、デスクトップではサイドバー) -->
            <div id="post-form-overlay">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 text-center flex-grow">新しい投稿</h2>
                    <button id="close-form-btn" class="text-gray-500 hover:text-gray-700 focus:outline-none hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="post-form" class="space-y-4 flex-grow flex flex-col">
                    <div class="space-y-4 space-x-4">
                    <div class="space-y-4 space-x-4">
                        <label for="post-text" class="block text-sm font-medium text-gray-700 mb-1">メッセージ</label>
                        <textarea id="post-text" name="postText" rows="4" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm resize-y" placeholder="ここにメッセージを入力してください..."></textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="latitude" class="block text-sm font-medium text-gray-700 mb-1">緯度</label>
                            <input type="text" id="latitude" name="latitude" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="longitude" class="block text-sm font-medium text-gray-700 mb-1">経度</label>
                            <input type="text" id="longitude" name="longitude" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">画像 (オプション)</label>
                        <input type="file" accept="image/*" id="post-image-input" name="postImage" class="hidden">
                        <button type="button" id="select-image-btn" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold">
                            画像を選択
                        </button>
                        <div id="image-preview-container" class="mt-2 hidden">
                            <img id="image-preview" src="#" alt="投稿画像" class="max-w-full h-auto rounded-md border border-gray-300">
                            <button type="button" id="clear-image-btn" class="mt-2 w-full bg-red-400 text-white py-1 px-3 rounded-md text-sm hover:bg-red-500 transition duration-150 ease-in-out">
                                画像をクリア
                            </button>
                        </div>
                    </div>
                    <!-- End Image Upload Section -->

                    <button type="button" id="get-location-btn" class="w-full bg-indigo-500 text-white py-3 px-4 rounded-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold shadow-md">
                        現在地を取得
                    </button>
                    <button type="submit" id="submit-post-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold shadow-md mt-auto">
                        投稿する
                    </button>
                </form>
                <div id="user-info-display" class="mt-4 p-2 bg-gray-100 text-gray-700 rounded-md text-xs text-center break-all hidden">
                    ユーザー名: 未設定
                    <button id="change-name-btn" class="ml-2 text-blue-500 hover:underline text-xs">変更</button>
                    <button id="logout-btn" class="ml-2 text-red-500 hover:underline text-xs">ログアウト</button>
                    <button id="account-btn" class="ml-2 text-blue-500 hover:underline text-xs" data-view="account">アカウントプロフィール</button>
                </div>
                <div id="non-login-menu" class="mt-4 p-2 bg-gray-100 text-gray-700 rounded-md text-xs text-center">
                </div>
                <div id="messages" class="mt-4 p-3 bg-blue-50 text-blue-800 rounded-md text-sm hidden"></div>
            </div>
            </div>
        </div>
            <!-- Account Settings Content (Initially Hidden) -->
            <div id="account-menu">
                <div class="flex items-center justify-between mb-4">
                <h2 class="flex items-center justify-between mb-4">アカウント設定</h2>
                <div class="space-y-4 space-x-4">
                <div class="flex items-center space-x-4 mb-4">
                    <img id="account-icon-preview" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="アイコンプレビュー" class="w-16 h-16 rounded-full object-cover bg-gray-200">
                    <div>
                        <h3 id="account-user-name" class="text-lg font-semibold text-gray-800"></h3>
                      <p id="account-user-handle" class="text-gray-500"></p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="account-name-input" class="block text-sm font-medium text-gray-700">ユーザー名</label>
                        <input type="text" id="account-name-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="account-bio-input" class="block text-sm font-medium text-gray-700">自己紹介</label>
                        <textarea id="account-bio-input" rows="3" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label for="account-icon-input" class="block text-sm font-medium text-gray-700">アイコン画像</label>
                        <input type="file" id="account-icon-input" accept="image/*" class="mt-1">
                    </div>
                    <div id="account-email-section">
                        <label for="account-email-input" class="block text-sm font-medium text-gray-700">メールアドレス</label>
                        <input type="email" id="account-email-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <p id="account-email-error" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    <div class="flex space-x-2">
                        <button id="save-account-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold">
                            保存
                        </button>
                <button id="logout-btn-account" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold">
                            ログアウト
                        </button>
                         <button id="switch-account-btn" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold">
                            アカウント切り替え
                        </button>
                 </div>
                </div>
                </div>
                </div>
                </div>
        <!-- User Profile Display Area (Initially Hidden) -->
        <div id="user-profile-view" class="hidden w-full h-full bg-white rounded-xl shadow-md p-6 flex-col">
                <!-- Profile content will be dynamically inserted here -->
            <!-- User Profile Display Area (Initially Hidden) -->
            <div id="user-profile-view" class="hidden w-full h-full bg-white rounded-xl shadow-md p-6 flex-col">
                <!-- Profile content will be dynamically inserted here -->
            </div>
        </div>

        <!-- Bottom Navigation Bar for Mobile -->
        <div id="bottom-nav" class="fixed bottom-0 left-0 w-full bg-white shadow-lg p-3 flex justify-around items-center z-20 md:hidden">
            <button id="nav-map-btn" class="flex flex-col items-center text-blue-600 hover:text-blue-800 focus:outline-none">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0L6.343 16.657a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="text-xs mt-1">マップ</span>
            </button>
            <button id="nav-post-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-800 focus:outline-none">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="text-xs mt-1">投稿</span>
            </button>
            <button id="nav-timeline-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-800 focus:outline-none">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span class="text-xs mt-1">タイムライン</span>
            </button>
            <button id="nav-account-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-800 focus:outline-none">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-xs mt-1">アカウント</span>
            </button>
    </div>

    <!-- Name Input Modal -->
    <div id="name-input-modal">
        <div class="modal-content text-left">
            <h3 class="text-xl font-semibold mb-2 text-gray-800">ユーザー情報設定</h3>
            <p class="text-sm text-gray-600 mb-6">表示される名前と、一意のIDを設定してください。</p>
            <form id="name-form" class="space-y-4">
                <div>
                    <label for="user-name-input" class="block text-sm font-medium text-gray-700">ユーザー名</label>
                    <input type="text" id="user-name-input" name="name" required
                           class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           placeholder="あなたの表示名">
                </div>
                <div>
                    <label for="user-id-input" class="block text-sm font-medium text-gray-700">ユーザーID</label>
                    <input type="text" id="user-id-input" name="username" required pattern="^@[a-zA-Z0-9_]{3,15}$"
                           class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           placeholder="@ + 英数字と_ (3〜15文字)">
                    <p id="username-error" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>
                <!-- Icon Upload -->
                <div>
                    <label for="user-icon-input" class="block text-sm font-medium text-gray-700">アイコン画像</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <img id="user-icon-preview" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="アイコンプレビュー" class="w-16 h-16 rounded-full object-cover bg-gray-200">
                        <input type="file" id="user-icon-input" class="hidden" accept="image/jpeg, image/png">
                        <button type="button" id="select-icon-btn" class="bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50">画像を選択</button>
                    </div>
                </div>
                <!-- Bio -->
                <div>
                    <label for="user-bio-input" class="block text-sm font-medium text-gray-700">一言</label>
                    <textarea id="user-bio-input" rows="3" maxlength="100" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="自己紹介など (100文字以内)"></textarea>
                
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold">
                    保存
                </button>
            </form>
            <div class="mt-6 border-t pt-4 border-gray-200">
                <p class="text-sm text-gray-600 mb-3 text-center">またはメールアドレスでログイン/登録:</p>
                <form id="email-password-form" class="space-y-4" onsubmit="return false;">
                    <div>
                        <label for="email-input" class="sr-only">メールアドレス</label>
                        <input type="email" id="email-input" name="email" required autocomplete="email" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="メールアドレス">
                    </div>
                    <div>
                        <label for="password-input" class="sr-only">パスワード</label>
                        <input type="password" id="password-input" name="password" required autocomplete="current-password" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="パスワード (6文字以上)">
                    </div>
                    <p id="email-error" class="text-red-500 text-xs mt-1 hidden"></p>
                    <div class="flex space-x-2">
                        <button type="button" id="email-login-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 font-semibold">ログイン</button>
                        <button type="button" id="email-signup-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 font-semibold">新規登録</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">確認</h3>
            <p id="confirm-message" class="text-sm text-gray-600 mb-6">本当にこの操作を実行しますか？</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-btn" class="bg-red-500 text-white py-2 px-5 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold">
                    はい
                </button>
                <button id="confirm-no-btn" class="bg-gray-300 text-gray-800 py-2 px-5 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold">
                    いいえ
                </button>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="profile-modal-title" class="text-xl font-bold text-gray-800">プロフィール</h3>
                <button id="close-profile-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="flex items-center space-x-4 mb-4">
                    <img id="profile-avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="プロフィール画像" class="w-20 h-20 bg-gray-300 rounded-full flex-shrink-0 object-cover">
                    <div class="flex-grow">
                        <h4 id="profile-user-name" class="text-2xl font-bold"></h4>
                        <p id="profile-user-handle" class="text-gray-500"></p>
                    </div>
                    <button id="profile-follow-btn" class="ml-auto bg-blue-500 text-white py-2 px-4 rounded-full text-sm font-semibold hidden">フォロー</button>
                </div>
                <p id="profile-bio" class="text-gray-700 mb-6 whitespace-pre-wrap"></p>
                <div class="flex space-x-6 text-sm text-gray-600 mb-6 border-t border-b py-3">
                    <div>
                        <span id="profile-following-count" class="font-bold text-base block text-gray-800">0</span>
                        <span>フォロー中</span>
                    </div>
                    <div>
                        <span id="profile-follower-count" class="font-bold text-base block text-gray-800">0</span>
                        <span>フォロワー</span>
                    </div>
                </div>
                <div id="profile-posts-container" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKをCDNから読み込む（グローバルなfirebaseオブジェクトを公開） -->
    <!-- v8.10.1はグローバルオブジェクトとしてアクセスする形式 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- メインのアプリケーションスクリプト (すべてのロジックをここに統合) -->
    <script>
        // Google Maps関連のグローバル変数
        let map = null;
        let currentGoogleMapMarker = null;
        let selectedGoogleMapMarker = null;
        let infoWindow = null;
        let mapElement = null;

        // Firebase関連のグローバル変数
        let app = null;
        let db = null;
        let auth = null;
        let storage = null;
        let analytics = null;
        let userId = null;
        let userName = "匿名ユーザー";
        let authReady = false;
        let userHandle = "";
        let userPhotoURL = null;
        let userBio = "";
        let currentUserFollowing = [];

        // DOM要素の参照をスクリプトのトップレベルで宣言 (DOMContentLoadedで初期化)
        let messagesDiv = null;
        let userInfoDisplay = null;
        let postFormOverlay = null;
        let openFormBtn = null;
        let closeFormBtn = null;
        let nameInputModal = null;
        let nameForm = null;
        let userNameInput = null;
        let userIdInput = null;
        let userBioInput = null;
        let userIconInput = null;
        let selectIconBtn = null;
        let userIconPreview = null;
        let usernameError = null;
        let googleSignInBtn = null;
        // Email/Password Auth elements
        let emailInput = null;
        let emailError = null;
        let logoutBtn = null;
        let postForm = null;
        let postText = null;
        let latitudeInput = null;
        longitudeInput = null
        let timelineContainer = null;
        let timelinePostsContainer = null;
        let timelineTabs = null;
        let currentTimelineTab = 'all';
        let submitPostBtn = null;

        // Profile Modal elements
        let userProfileModal = null;
        let closeProfileBtn = null;
        let profileUserName = null;
        let profileUserHandle = null;
        let profileBio = null;
        let profileFollowBtn = null;
        let profileFollowingCount = null;
        let profileFollowerCount = null;
        let profileAvatar = null;
        let profilePostsContainer = null;

        // Confirmation Modal elements
        let confirmModal = null;
        let confirmMessage = null;
        let confirmYesBtn = null;
        let desktopTabs = null;
        let nonLoginMenu = null;
        let accountBtn = null;
        let confirmNoBtn = null;

        // Account settings elements (Desktop)
        let accountMenu = null;
        let accountUserNameInput = null;
        let accountBioInput = null;
        let accountIconInput = null;
        let accountIconPreview = null;
        let saveAccountBtn = null;
        let currentActionPostId = null;

        // Canvas環境から提供されるグローバル変数を使用
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBSqI_ertL6zvom68xRDJEiUSqaLT-cLvk",
            authDomain: "mater-4c79d.firebaseapp.com",
            projectId: "mater-4c79d",
            storageBucket: "mater-4c79d.firebasestorage.app",
            messagingSenderId: "155663048531",
            appId: "1:155663048531:web:7d571cf2d1240efde64ba6",
            measurementId: "G-6KST2VXSK5"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : defaultFirebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firebase設定の初期化をIIFEで隔離
        const firebaseConfig = (function() {
            let config = defaultFirebaseConfig;
            if (typeof __firebase_config !== 'undefined' && __firebase_config !== null) {
                try {
                    const parsedConfig = JSON.parse(__firebase_config);
                    if (typeof parsedConfig === 'object' && parsedConfig !== null && parsedConfig.apiKey) {
                        config = parsedConfig;
                        console.log("Using provided firebaseConfig:", config);
                    } else {
                    }
                } catch (e) {
                    console.error("Error parsing __firebase_config, using defaultFirebaseConfig:", e);
                }
            } else {
                console.warn("__firebase_config is undefined or null. Using defaultFirebaseConfig.");
            }
            return config;
        })();
         
        function updateUserInfoDisplay() {
            if (!userInfoDisplay) {
                userInfoDisplay = document.getElementById('user-info-display');
            if (!userInfoDisplay) {
              console.error("userInfoDisplay element not found.");
            }
          }
          if (userId) {
            const displayText = userHandle ? `${userName} (${userHandle})` : (userName || '未設定');
            userInfoDisplay.innerHTML = `ユーザー: ${displayText}
            ${ userHandle ? `<button id="show-profile-btn" class="ml-2 text-blue-500 hover:underline text-xs">プロフィール</button>`:''}
            ${ window.innerWidth < 768 ?
              `<button id="account-btn" class="ml-2 text-blue-500 hover:underline text-xs" data-view="account">アカウント</button>`: ''
            }
                        <button id="change-name-btn" class="ml-2 text-blue-500 hover:underline text-xs">変更</button>
                        <button id="logout-btn" class="ml-2 text-red-500 hover:underline text-xs">ログアウト</button>`;
            if (window.innerWidth < 768) {
                userInfoDisplay.innerHTML += `<button id="account-btn" class="ml-2 text-blue-500 hover:underline text-xs" data-view="account">アカウント</button>`;
            } else {
            userInfoDisplay.textContent = 'ログインしていません';
            // ログインしていない場合のメニュー表示
            nonLoginMenu.style.display = 'block';
                          if (showLoginModalBtn) {
            userInfoDisplay.innerHTML = 'ログインしていません';
            showLoginModalBtn.addEventListener('click', () => nameInputModal.classList.add('active'));
          }
        }
        }
              
};

        /**
         * メッセージを表示するヘルパー関数
         * @param {string} message - 表示するメッセージ
         * @param {string} type - 'success', 'error', 'info' などのタイプ
         */
        function showMessage(message, type = 'info') {
            // DOMContentLoaded前に呼び出される可能性があるので、ここで改めて取得を試みる
            if (!messagesDiv) {
                messagesDiv = document.getElementById('messages');
                if (!messagesDiv) return;
            }

            messagesDiv.textContent = message;
            messagesDiv.classList.remove('hidden', 'bg-blue-50', 'text-blue-800', 'bg-green-50', 'text-green-800', 'bg-red-50', 'text-red-800');
            messagesDiv.classList.add('block');

            setTimeout(() => {
                messagesDiv.classList.add('hidden');
                messagesDiv.classList.remove('bg-green-50', 'text-green-800', 'bg-red-50', 'text-red-800', 'bg-blue-50', 'text-blue-800');
            }, 3000);
        }; // セミコロンを追加


        /**
         * HTML特殊文字をエスケープする関数
         * @param {string} str - エスケープする文字列
         * @returns {string} エスケープされた文字列
         */
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }; // セミコロンを追加

        /**
         * Firebase Authのエラーコードを日本語メッセージに変換する関数
         * @param {object} error - Firebase Authのエラーオブジェクト
         * @returns {string} 日本語のエラーメッセージ
         */
        function getFirebaseAuthErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return '無効なメールアドレス形式です。';
                case 'auth/user-disabled':
                    return 'このアカウントは無効です。';
                case 'auth/user-not-found':
                    return 'このメールアドレスは登録されていません。';
                case 'auth/wrong-password':
                    return 'パスワードが間違っています。';
                case 'auth/email-already-in-use':
                    return 'このメールアドレスは既に使用されています。';
                case 'auth/weak-password':
                    return 'パスワードは6文字以上で入力してください。';
                default:
                    console.error("Unhandled auth error:", error);
                    return '認証に失敗しました。時間をおいて再試行してください。';
            }
        };

        // Google Maps APIが読み込まれた後に呼び出されるグローバル関数
        window.initGoogleMap = function() {
            mapElement = document.getElementById('map');

            // マップの中心を東京に設定し、ズームレベル13で初期化
            map = new google.maps.Map(mapElement, {
                center: { lat: 35.6895, lng: 139.6917 },
                zoom: 13,
                mapTypeControl: false,
                streetViewControl: false
            });

            infoWindow = new google.maps.InfoWindow();

            console.log("Googleマップが初期化されました。");

            // マップクリックイベントリスナー
            map.addListener('click', (e) => {
                const lat = e.latLng.lat();
                const lng = e.latLng.lng();

                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lng.toFixed(6);

                if (selectedGoogleMapMarker) {
                    selectedGoogleMapMarker.setMap(null);
                }
                selectedGoogleMapMarker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: '#8B5CF6',
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2,
                        scale: 8
                    }
                });
                infoWindow.setContent('選択された投稿位置');
                infoWindow.open(map, selectedGoogleMapMarker);

                showMessage(`マップで位置を選択しました: 緯度 ${lat.toFixed(6)}, 経度 ${lng.toFixed(6)}`, 'info');
            });

            // 初期ロード時に現在地を取得
            getCurrentLocation();
            // Firebase関連の初期化とデータ取得は、Google Mapが準備できた後に行う
            initializeFirebaseAndFetchPosts();
        }; // セミコロンを追加


        /**
         * 現在地を取得し、マップに表示する関数
         */
        function getCurrentLocation() {
            if (navigator.geolocation) {
                showMessage("現在地を取得中...", 'info');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const latLng = new google.maps.LatLng(lat, lng);

                        document.getElementById('latitude').value = lat.toFixed(6);
                        document.getElementById('longitude').value = lng.toFixed(6);

                        if (currentGoogleMapMarker) {
                            currentGoogleMapMarker.setMap(null);
                        }
                        if (selectedGoogleMapMarker) {
                            selectedGoogleMapMarker.setMap(null);
                            selectedGoogleMapMarker = null;
                        }

                        map.setCenter(latLng);
                        map.setZoom(15);

                        currentGoogleMapMarker = new google.maps.Marker({
                            position: latLng,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#EF4444',
                                fillOpacity: 1,
                                strokeColor: '#FFFFFF',
                                strokeWeight: 2,
                                scale: 8
                            }
                        });
                        infoWindow.setContent('あなたの現在地');
                        infoWindow.open(map, currentGoogleMapMarker);

                        showMessage('現在地を取得しました！', 'success');
                        console.log(`現在地: 緯度 ${lat}, 経度 ${lng}`);
                    },
                    (error) => {
                        console.error("現在地の取得に失敗しました:", error);
                        let errorMessage = "現在地の取得に失敗しました。";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += "位置情報の利用が許可されていません。";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += "位置情報が利用できません。";
                                break;
                            case error.TIMEOUT:
                                errorMessage += "位置情報の取得がタイムアウトしました。";
                                break;
                            default:
                                errorMessage += "不明なエラーが発生しました。";
                                break;
                        }
                        showMessage(errorMessage, 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                showMessage('お使いのブラウザはGeolocationをサポートしていません。', 'error');
                console.warn("Geolocationはサポートされていません。");
            }
        }; // セミコロンを追加


        /**
         * Firebaseの初期化と投稿の取得を行う関数
         */
        async function initializeFirebaseAndFetchPosts() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                console.log("Firebase app initialized:", app);
                analytics = firebase.analytics();
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();

                // Handle Google sign-in redirect result
                auth.getRedirectResult().catch((error) => {
                    console.error("Google認証リダイレクト結果の取得に失敗:", error);
                });

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        authReady = true;

                        const userDocRef = db.collection(`artifacts/${appId}/public/data/users`).doc(userId);
                        const userDocSnap = await userDocRef.get();

                        if (userDocSnap.exists && userDocSnap.data().name) {
                            const userData = userDocSnap.data();
                            userName = userData.name;
                            // Firestoreから読み込んだ値をグローバル変数にセット
                            // (followingCount, followerCount は表示時に直接使うのでここでは不要)
                            userPhotoURL = userData.photoURL || null;
                            userHandle = userData.username || '';
                            userPhotoURL = userData.photoURL || null;
                            userBio = userData.bio || '';
                            updateUserInfoDisplay();
                            nameInputModal.classList.remove('active');
                            console.log("DEBUG: Attempting to fetch posts after auth ready.");
                            fetchPosts();
                            fetchTimelinePosts();
                            fetchFollowingList();
                            nonLoginMenu.style.display = 'none';
                        } else if (user.displayName) {
                            userName = user.displayName;
                            userInfoDisplay.textContent = `ユーザー名: ${userName} (Google)`;
                            // 新規ユーザー作成時にカウントフィールドを追加
                            await userDocRef.set({
                                name: userName,
                                createdAt: new Date().toISOString(),
                                authProvider: user.providerData[0].providerId || 'google',
                                followingCount: 0,
                                followerCount: 0,
                                bio: '' // bioフィールドも初期化
                            }, { merge: true });

                            console.log("DEBUG: Attempting to fetch posts after Google auth and name set.");
                            nameInputModal.classList.remove('active');
                            fetchPosts();
                            fetchTimelinePosts();
                            fetchFollowingList();
                            nonLoginMenu.style.display = 'none';
                        }
                    } else {
                        // ユーザーがログアウトした場合の処理
                        nameInputModal.classList.add('active');
                        userId = null;
                        userName = "匿名ユーザー";
                        userHandle = "";
                        currentUserFollowing = [];
                        updateUserInfoDisplay();
                        nonLoginMenu.style.display = 'block';
                        if (map) map.data.forEach(feature => map.data.remove(feature));
                        timelinePostsContainer.innerHTML = '<p class="text-gray-500 text-center">投稿がありません。</p>';
                        userNameInput.value = ''; // ユーザー名入力をクリア
                        userIdInput.value = ''; // ユーザーID入力をクリア
                        console.log("User logged out, showing name input modal.");
                        // ログアウト時にローカルストレージのいいね情報をクリア
                        clearLikedPostsFromLocalStorage();
                    }
                    if (user) {
                        loadLikedPostsFromLocalStorage();
                    }
                    updateUserInfoDisplay();
                    function loadLikedPostsFromLocalStorage() {
                        const likedPostsKey = getLikedPostsKey();
                        let likedPosts = localStorage.getItem(likedPostsKey);
                        if (likedPosts) {
                            try {
                                likedPosts = JSON.parse(likedPosts);
                            } catch (e) {
                                likedPosts = [];
                            }
                        }
                        localStorage.setItem(likedPostsKey, JSON.stringify(likedPosts || []));
                    }
                });
                if (accountMenu) {
             accountMenu.addEventListener('click', async (event) => {
                if (event.target.id === 'logout-btn-account') {
                    try {
                        await auth.signOut();
                        showMessage('ログアウトしました。', 'info');
                        switchView('map');
                    } catch (error) {
                        console.error("ログアウトに失敗しました:", error);
                        showMessage('ログアウトに失敗しました。', 'error');
                    }
                } else if (event.target.id === 'switch-account-btn') {
                   try {
                        auth.signOut();
                        showMessage('アカウントを切り替えます。', 'info');
                        nameInputModal.classList.add('active');
                       switchView('map');
                    } catch (error) {
                        console.error("アカウントの切り替えに失敗しました:", error);
                        showMessage('アカウントの切り替えに失敗しました。', 'error');
                    }
                }
            });
           }

            } catch (error) {
                console.error("Firebaseの初期化に失敗しました:", error);
                showMessage("アプリケーションの初期化に失敗しました。", "error");
            }
        } // セミコロンを追加


        /**
         * Firebaseから投稿をリアルタイムで取得し、マップに表示する関数
         */
        function fetchPosts() {
            if (!authReady) {
                console.warn("認証が完了していません。マップ投稿の取得を遅延します。");
                return;
            }
            if (!db) {
                console.error("Firestore database (db) is not initialized.");
                showMessage("データベースが初期化されていません。", "error");
                return;
            }

            const postsColRef = db.collection(`artifacts/${appId}/public/data/posts`);
            console.log("DEBUG: Subscribing to Firestore posts collection for map.");

            postsColRef.onSnapshot(snapshot => {
                console.log(`マップ用: Firestoreから ${snapshot.size} 件の投稿をリアルタイムで同期しました。`);
                if (map) {
                    map.data.forEach(feature => {
                        map.data.remove(feature);
                    });
                }
                
                snapshot.forEach(doc => {
                    const post = doc.data();
                    post.id = doc.id;
                    addPostToMap(post);
                });
            }, error => {
                console.error("DEBUG: Firestore onSnapshot for map failed with error:", error);
                showMessage("マップ投稿の取得中にエラーが発生しました。", "error");
            }); // セミコロンを追加
        }; // セミコロンを追加


        /**
         * マップに投稿マーカーを追加する関数 (Google Maps用)
         * @param {object} post - 投稿オブジェクト
         */
        function addPostToMap(post) {
            if (!post.latitude || !post.longitude || (!post.text && !post.imageUrl) || !map || !post.id) {
                console.warn("無効な投稿データまたはマップが未初期化です:", post);
                return;
            }

            const latLng = new google.maps.LatLng(post.latitude, post.longitude);
            const postDate = new Date(post.timestamp);
            const now = new Date();
            const diffTime = Math.abs(now.getTime() - postDate.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const likesCount = post.likedBy ? post.likedBy.length : 0;
            const isLikedByMe = userId && post.likedBy && post.likedBy.includes(userId);
            const likeButtonText = isLikedByMe ? `いいね済み (${likesCount})` : `いいね (${likesCount})`;
            const likeButtonClass = isLikedByMe ? 'bg-pink-500 hover:bg-pink-600' : 'bg-gray-400 hover:bg-gray-500';

            const escapedPostText = escapeHTML(post.text || '');
            const escapedPostUserName = escapeHTML(post.userName);

            const infoWindowContent = `
            <div class="p-2 font-sans text-sm">
                    <p class="font-bold text-gray-800 mb-1">${postDate.toLocaleString()}</p>
                    <p class="text-gray-700 mb-2">投稿者: ${escapedPostUserName}</p>
                    ${post.imageUrl ? `<img src="${escapeHTML(post.imageUrl)}" alt="投稿画像" class="my-2 rounded-md max-w-full h-auto" style="max-height: 150px; object-fit: contain;">` : ''}
                    <p class="text-gray-900 mb-3">${escapedPostText}</p>
                    <div class="flex items-center space-x-2">
                        <button class="like-btn text-white py-1 px-3 rounded-md text-xs transition duration-150 ease-in-out ${likeButtonClass}" data-post-id="${post.id}" data-liked-by="${JSON.stringify(post.likedBy || [])}">
                            ${likeButtonText}
                        </button>
            `;
             map.data.add({
                geometry: new google.maps.Data.Point(latLng),
                properties: {
                    text: post.text,
                    userName: post.userName,
                    timestamp: post.timestamp,
                    id: post.id,
                    userId: post.userId,
                    likedBy: post.likedBy || [],
                    imageUrl: post.imageUrl || null
                }
            });

            map.data.setStyle({
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#10B981',
                    fillOpacity: 1.0, // すべての投稿を不透明で表示
                    strokeColor: '#FFFFFF',
                    strokeWeight: 2,
                    scale: 8
                }
            });

            map.data.addListener('click', function(event) {
                const clickedPostId = event.feature.getProperty('id');
                const clickedPostUserId = event.feature.getProperty('userId');
                const clickedPostLikedBy = event.feature.getProperty('likedBy');
                const clickedPostTimestamp = event.feature.getProperty('timestamp');
                const clickedPostDateFormatted = new Date(clickedPostTimestamp).toLocaleString();
                const clickedPostUserName = escapeHTML(event.feature.getProperty('userName') || '');
                const clickedPostText = escapeHTML(event.feature.getProperty('text') || '');
                const clickedPostImageUrl = event.feature.getProperty('imageUrl');

                let currentInfoWindowContent = `
                    <div class="p-2 font-sans text-sm">
                        <p class="font-bold text-gray-800 mb-1">${clickedPostDateFormatted}</p>
                        <p class="text-gray-700 mb-2">投稿者: 
                            <button class="user-profile-link text-blue-600 hover:underline" data-user-id="${clickedPostUserId}">${clickedPostUserName}</button>
                        </p>
                        ${clickedPostImageUrl ? `<img src="${escapeHTML(clickedPostImageUrl)}" alt="投稿画像" class="my-2 rounded-md max-w-full h-auto" style="max-height: 150px; object-fit: contain;">` : ''}
                        <p class="text-gray-900 mb-3 whitespace-pre-wrap">${clickedPostText}</p>
                        <div class="flex items-center space-x-2">
                            <button class="like-btn text-white py-1 px-3 rounded-md text-xs transition duration-150 ease-in-out ${clickedPostLikedBy && userId && clickedPostLikedBy.includes(userId) ? 'bg-pink-500 hover:bg-pink-600' : 'bg-gray-400 hover:bg-gray-500'}" data-post-id="${clickedPostId}" data-liked-by="${JSON.stringify(clickedPostLikedBy)}">
                                ${clickedPostLikedBy && clickedPostLikedBy.includes(userId) ? `いいね済み (${clickedPostLikedBy.length})` : `いいね (${clickedPostLikedBy.length})`}
                            </button>
                `;

                if (userId && clickedPostUserId === userId) {
                    currentInfoWindowContent += `
                            <button class="delete-btn bg-red-500 text-white py-1 px-3 rounded-md text-xs hover:bg-red-600 transition duration-150 ease-in-out" data-post-id="${clickedPostId}">
                                削除
                            </button>
                    `;
                }
                currentInfoWindowContent += `
                    </div>
                </div>
            `;

            infoWindow.setContent(currentInfoWindowContent);
            infoWindow.setPosition(event.feature.getGeometry().get());
            infoWindow.open(map);

            console.log(`マップにマーカーを追加しました: ${post.text} (${post.latitude}, ${post.longitude})`);
        });} // セミコロンを追加


        /**
         * Firebaseからタイムライン用の投稿をリアルタイムで取得し、表示する関数
         */
        function fetchTimelinePosts(filter = 'all') {
            if (!authReady) {
                console.warn("認証が完了していません。タイムライン投稿の取得を遅延します。");
                return;
            }
            if (!db) {
                console.error("Firestore database (db) is not initialized.");
                showMessage("データベースが初期化されていません。", "error");
                return;
            }

            let postsQuery = db.collection(`artifacts/${appId}/public/data/posts`);
            
            if (filter === 'following') {
                if (currentUserFollowing.length === 0) {
                    timelinePostsContainer.innerHTML = '<p class="text-gray-500 text-center">フォロー中のユーザーの投稿はありません。</p>';
                    return;
                }
                // Firestore 'in' query has a limit of 30 values in the array
                postsQuery = postsQuery.where('userId', 'in', currentUserFollowing.slice(0, 30));
            }
            postsQuery = postsQuery.orderBy('timestamp', 'desc');

            console.log("DEBUG: Subscribing to Firestore posts collection for timeline.");
            
            postsQuery.onSnapshot((snapshot) => {
                console.log(`タイムライン用: Firestoreから ${snapshot.size} 件の投稿をリアルタイムで同期しました。`);
                timelinePostsContainer.innerHTML = '';

                if (snapshot.empty) {
                    timelinePostsContainer.innerHTML = '<p class="text-gray-500 text-center">投稿がありません。</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const post = { ...doc.data(), id: doc.id };
                    const postElement = createPostElement(post, 'timeline');
                    timelinePostsContainer.appendChild(postElement);
                });
            }, (error) => {
                console.error("DEBUG: Firestore onSnapshot for timeline failed with error:", error);
                showMessage("タイムライン投稿の取得中にエラーが発生しました。", "error");
            });
        }


        /**
         * ユーザーのフォローリストを取得する関数
         */
        function fetchFollowingList() {
            if (!authReady || !userId) {
                console.warn("認証が完了していません。フォローリストの取得を遅延します。");
                return;
            }
            if (!db) {
                console.error("Firestore database (db) is not initialized.");
                return;
            }

            const followDocRef = db.collection(`artifacts/${appId}/public/data/follows`).doc(userId);
            console.log("DEBUG: Subscribing to current user's follow list.");

            followDocRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    currentUserFollowing = docSnap.data().following || [];
                    console.log("DEBUG: Current user following list updated:", currentUserFollowing);
                } else {
                    currentUserFollowing = [];
                    console.log("DEBUG: Current user has no following list.");
                }
                fetchTimelinePosts(currentTimelineTab); // Follow list update might affect the timeline
            }, (error) => {
                console.error("DEBUG: Firestore onSnapshot for follow list failed with error:", error);
                showMessage("フォローリストの取得中にエラーが発生しました。", "error");
            });
        };


        /**
         * 投稿を削除する関数
         * @param {string} postId - 削除する投稿のID
         */
        async function deletePost(postId) {
            try {
                if (!db || !userId) {
                    showMessage('認証またはデータベースが準備できていません。', 'error');
                    return;
                }
                await db.collection(`artifacts/${appId}/public/data/posts`).doc(postId).delete();
                showMessage('投稿を削除しました！', 'success');
                infoWindow.close();
            } catch (error) {
                console.error("投稿の削除に失敗しました:", error);
                showMessage('投稿の削除に失敗しました。', 'error');
            }
        };


        /**
         * いいねを切り替える関数
         * @param {string} postId - いいねを切り替える投稿のID
         * @param {Array<string>} currentLikedBy - 現在のいいねしたユーザーIDの配列
         */
        async function toggleLike(postId, currentLikedBy) {
            if (!db || !userId) {
                showMessage('認証またはデータベースが準備できていません。', 'error');
                return;
            }

            const postRef = db.collection(`artifacts/${appId}/public/data/posts`).doc(postId);
            const batch = db.batch();

            if (currentLikedBy.includes(userId)) {
                batch.update(postRef, {
                    likedBy: firebase.firestore.FieldValue.arrayRemove(userId)
                });
                showMessage('いいねを解除しました。', 'info');
            } else {
                batch.update(postRef, {
                    likedBy: firebase.firestore.FieldValue.arrayUnion(userId)
                });
                showMessage('いいねしました！', 'success');
            }

            try {
                await batch.commit();
            } catch (error) {
                console.error("いいねの更新に失敗しました:", error);
                showMessage('いいねの更新に失敗しました。', 'error');
            }
        };


        /**
         * フォロー/フォロー解除を切り替える関数
         * @param {string} targetUserId - フォロー/解除対象のユーザーID
         */
        async function toggleFollow(targetUserId) {
            if (!db || !userId) {
                showMessage('認証またはデータベースが準備できていません。', 'error');
                return;
            }
            if (userId === targetUserId) {
                showMessage('自分自身をフォロー/フォロー解除することはできません。', 'error');
                return;
            }

            const isCurrentlyFollowing = currentUserFollowing.includes(targetUserId);

            // Firestoreのフォローリストを更新（これはUIの即時反映のために残す）
            const followDocRef = db.collection(`artifacts/${appId}/public/data/follows`).doc(userId);
            const updateAction = isCurrentlyFollowing 
                ? firebase.firestore.FieldValue.arrayRemove(targetUserId)
                : firebase.firestore.FieldValue.arrayUnion(targetUserId);
            
            await followDocRef.set({ following: updateAction }, { merge: true });

            showMessage(isCurrentlyFollowing ? 'フォローを解除しました。' : 'フォローしました！', 'success');
        };


        /**
         * 画像をFirebase Storageにアップロードし、ダウンロードURLを返す関数
         * @param {File} file - アップロードする画像ファイル
         * @returns {Promise<string|null>} ダウンロードURL、またはエラーの場合はnull
         */
        async function uploadImage(file, purpose = 'post') {
            if (!storage || !userId) {
                showMessage('アップロードの準備ができていません。', 'error');
                console.error("Upload failed: Storage or userId not ready. userId:", userId); 
                return null;
            }

            let storagePath;
            if (purpose === 'profile') {
                // ユーザーアイコンは同じパスに上書きする
                storagePath = `artifacts/${appId}/public/images/users/${userId}/profile_icon`;
            } else {
                const uniqueFileName = `${Date.now()}_${file.name}`;
                storagePath = `artifacts/${appId}/public/images/posts/${uniqueFileName}`;
            }
            const storageRef = storage.ref(storagePath);
            
            const metadata = {
                contentType: file.type // ファイルのMIMEタイプを明示
            };

            try {
                showMessage('画像をアップロード中...', 'info');

                const snapshot = await storageRef.put(file, metadata);
                const downloadURL = await snapshot.ref.getDownloadURL();
                showMessage('画像のアップロードが完了しました！', 'success');
                return downloadURL;
            } catch (error) {
                showMessage('画像のアップロードに失敗しました。', 'error');
                return null;
            } finally {
                submitPostBtn.disabled = false;
                selectImageBtn.disabled = false;
            }
        };


        /**
         * 確認モーダルを表示する
         * @param {string} message - モーダルに表示するメッセージ
         * @param {string} postId - アクションに関連する投稿ID
         */
        function showConfirmModal(message, postId) {
            confirmModal.classList.add('active');
            confirmMessage.textContent = message;
            currentActionPostId = postId;
        };


        /**
         * 確認モーダルを閉じる
         */
        function hideConfirmModal() {
            confirmModal.classList.remove('active');
            currentActionPostId = null;
        }
        

        /**
         * ビューを切り替える関数
         * @param {string} view - 'map', 'post', 'timeline'
        */
        function switchView(view) {
            document.getElementById('map-area').style.display = 'none';
            document.getElementById('user-profile-view').style.display = 'none';
            accountMenu.style.display = 'none';
            postFormOverlay.style.display = 'none';
            timelineContainer.style.display = 'none';
            
            navMapBtn.classList.remove('text-blue-600');
            navMapBtn.classList.add('text-gray-600');
            navPostBtn.classList.remove('text-blue-600');
            navPostBtn.classList.add('text-gray-600');
            navTimelineBtn.classList.remove('text-blue-600');
            navTimelineBtn.classList.add('text-gray-600');
            navAccountBtn.classList.remove('text-blue-600');
            navAccountBtn.classList.add('text-gray-600');

            if (view === 'map') {
                document.getElementById('map-area').style.display = 'block';
                navMapBtn.classList.add('text-blue-600');
                accountMenu.style.display = 'none';
            }
            else if (view === 'post') {
                document.getElementById('map-area').style.display = 'block';
                postFormOverlay.style.display = 'flex';
                navPostBtn.classList.add('text-blue-600');
                accountMenu.style.display = 'none';
            }
            else if (view === 'account') {
                document.getElementById('map-area').style.display = 'block';
                accountMenu.style.display = 'flex';
                navAccountBtn.classList.add('text-blue-600'); // Reusing timeline button for account
            }
            else if (view === 'timeline') {
                document.getElementById('map-area').style.display = 'block';
                timelineContainer.style.display = 'flex';
                navTimelineBtn.classList.add('text-blue-600');
                fetchTimelinePosts();
            } else {
                console.warn(`switchView: Unknown view "${view}"`);
                // 意図しないviewが指定された場合の処理（例: マップビューをデフォルトにする）
                switchView('map');
            }
        }



        // DOMContentLoadedイベントで初期化処理を実行
        document.addEventListener('DOMContentLoaded', () => {
            messagesDiv = document.getElementById('messages');
            userInfoDisplay = document.getElementById('user-info-display');
            postFormOverlay = document.getElementById('post-form-overlay');
            openFormBtn = document.getElementById('open-form-btn');
            closeFormBtn = document.getElementById('close-form-btn');
          nameInputModal = document.getElementById('name-input-modal');
            nameForm = document.getElementById('name-form');
            userBioInput = document.getElementById('user-bio-input');
            userIconInput = document.getElementById('user-icon-input');
            selectIconBtn = document.getElementById('select-icon-btn');
            userIconPreview = document.getElementById('user-icon-preview');
            userNameInput = document.getElementById('user-name-input');
            userIdInput = document.getElementById('user-id-input');
            usernameError = document.getElementById('username-error');
            googleSignInBtn = document.getElementById('google-sign-in-btn');
            emailInput = document.getElementById('email-input');
            passwordInput = document.getElementById('password-input');
                   emailLoginBtn = document.getElementById('email-login-btn');
            emailSignupBtn = document.getElementById('email-signup-btn');
                   emailError = document.getElementById('email-error');
                   changeNameBtn = document.getElementById('change-name-btn');
                   logoutBtn = document.getElementById('logout-btn');
            postForm = document.getElementById('post-form');
            postText = document.getElementById('post-text');
            latitudeInput = document.getElementById('latitude');
            longitudeInput = document.getElementById('longitude');
            getLocationBtn = document.getElementById('get-location-btn');
            postImageInput = document.getElementById('post-image-input');
            selectImageBtn = document.getElementById('select-image-btn');
            imagePreviewContainer = document.getElementById('image-preview-container');
            imagePreview = document.getElementById('image-preview');
            clearImageBtn = document.getElementById('clear-image-btn');
            submitPostBtn = document.getElementById('submit-post-btn');
            navMapBtn = document.getElementById('nav-map-btn');
            navPostBtn = document.getElementById('nav-post-btn');
            navTimelineBtn = document.getElementById('nav-timeline-btn');
            navAccountBtn = document.getElementById('nav-account-btn');
            userProfileView = document.getElementById('user-profile-view');
            showLoginModalBtn = document.getElementById('show-login-modal-btn');
            mainContent = document.getElementById('main-content');
            mainContentWrapper = document.getElementById('main-content-wrapper');
            timelineContainer = document.getElementById('timeline-container');
            timelinePostsContainer = document.getElementById('timeline-posts');
            timelineTabs = document.getElementById('timeline-tabs');

            // Profile modal elements initialization
            userProfileModal = document.getElementById('user-profile-modal');
            closeProfileBtn = document.getElementById('close-profile-btn');
            profileUserName = document.getElementById('profile-user-name');
            profileUserHandle = document.getElementById('profile-user-handle');
            profileBio = document.getElementById('profile-bio');
            profileFollowBtn = document.getElementById('profile-follow-btn');
            profileFollowingCount = document.getElementById('profile-following-count');
            profileFollowerCount = document.getElementById('profile-follower-count');
            profileAvatar = document.getElementById('profile-avatar');
            profilePostsContainer = document.getElementById('profile-posts-container');
            
            // Account menu elements initialization (Desktop)
            accountMenu = document.getElementById('account-menu');
            accountUserNameInput = document.getElementById('account-name-input');
            accountBioInput = document.getElementById('account-bio-input');
            accountIconInput = document.getElementById('account-icon-input');
            accountIconPreview = document.getElementById('account-icon-preview');
            saveAccountBtn = document.getElementById('save-account-btn');


            confirmModal = document.getElementById('confirm-modal');
            confirmMessage = document.getElementById('confirm-message');
            confirmYesBtn = document.getElementById('confirm-yes-btn');
            desktopTabs = document.getElementById('desktop-tabs');
            confirmNoBtn = document.getElementById('confirm-no-btn');
            nonLoginMenu = document.getElementById('non-login-menu');

            if (confirmYesBtn) {
                confirmYesBtn.addEventListener('click', () => {
                    if (currentActionPostId) {
                        deletePost(currentActionPostId);
                    }
                    hideConfirmModal();
                });
            }
            if (confirmNoBtn) {
                confirmNoBtn.addEventListener('click', () => {
                    hideConfirmModal();
                });
            }

            if (selectImageBtn) {
                selectImageBtn.addEventListener('click', () => {
                    postImageInput.click();
                });
            }

            if (postImageInput) {
                postImageInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.src = e.target.result;
                            imagePreviewContainer.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.src = '#';
                        imagePreviewContainer.classList.add('hidden');
                    }
                });
            }

            if (clearImageBtn) {
                clearImageBtn.addEventListener('click', () => {
                    postImageInput.value = '';
                    imagePreview.src = '#';
                    imagePreviewContainer.classList.add('hidden');
                });
            }
            
            if(accountIconInput) {
                accountIconInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        accountIconPreview.src = URL.createObjectURL(file);
                    }
                });
            }

            if(selectIconBtn) {
                selectIconBtn.addEventListener('click', () => userIconInput.click());
            }

            if(userIconInput) {
                userIconInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        userIconPreview.src = URL.createObjectURL(file);
                    }
                });
            }
            
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    if (mapElement && map && entry.target === mapElement) {
                        console.log("ResizeObserver detected map element resize. Google Maps handles this automatically.");
                    }
                }
                
                if (map) {
                    map.data.setStyle(map.data.getStyle());
                }
            });
            resizeObserver.observe(document.getElementById('map-area'));

            nameForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const inputName = userNameInput.value.trim();
                const inputUsername = userIdInput.value.trim();
                const inputBio = userBioInput.value.trim();
                const iconFile = userIconInput.files[0];
                usernameError.classList.add('hidden');

                if (!inputName || !inputUsername) {
                    showMessage('ユーザー名とユーザーIDの両方を入力してください。', 'error');
                    return;
                }

                if (!/^@[a-zA-Z0-9_]{3,15}$/.test(inputUsername)) {
                    usernameError.textContent = 'IDは@で始め、3〜15文字の英数字と_のみ使用できます。';
                    usernameError.classList.remove('hidden');
                    return;
                }
                
                // Check if username is being changed or set for the first time
                if (inputUsername !== userHandle) {
                    const exists = await checkUsernameExists(inputUsername);
                    if (exists) {
                        usernameError.textContent = 'このユーザーIDは既に使用されています。';
                        usernameError.classList.remove('hidden');
                        return;
                    }
                }

                submitPostBtn.disabled = true; // 連続送信防止
                try {
                    let newPhotoURL = userPhotoURL;
                    if (iconFile) {
                        newPhotoURL = await uploadImage(iconFile, 'profile');
                    }
                    const userDocRef = db.collection(`artifacts/${appId}/public/data/users`).doc(userId);
                    const userData = {
                        name: inputName,
                        username: inputUsername,
                        bio: inputBio
                    };

                    // アイコンとカウント数は、既存の値がある場合はマージ時に維持される
                    const updateData = {
                        photoURL: newPhotoURL,
                        updatedAt: new Date().toISOString()
                    };
                    
                    await userDocRef.set(userData, { merge: true });
                    
                    const nameChanged = userName !== inputName; 
                    const handleChanged = userHandle !== inputUsername;

                    userName = inputName;
                    userHandle = inputUsername;
                    userPhotoURL = newPhotoURL;
                    userBio = inputBio;

                    // Update posts only if name or handle changed
                    if (nameChanged || handleChanged) {
                        await updatePostsUserInfo(userId, userName, userHandle);
                    }

                    updateUserInfoDisplay();
                    nameInputModal.classList.remove('active');
                    showMessage('ユーザー情報が保存されました！', 'success');
                    
                    console.log("DEBUG: Attempting to fetch posts after name set.");

                    fetchPosts();
                    fetchTimelinePosts(currentTimelineTab);
                } catch (error) {
                    console.error("ユーザー情報の保存に失敗しました:", error);
                    showMessage('ユーザー情報の保存に失敗しました。', 'error');
                } finally {
                    submitPostBtn.disabled = false;
                }
            });


            /**
             * ユーザー名とIDの変更を投稿データに反映する関数
             * @param {string} userId - ユーザーID
             * @param {string} newUserName - 新しいユーザー名
             * @param {string} newUserHandle - 新しいユーザーID
             */
            async function updatePostsUserInfo(userId, newUserName, newUserHandle) {
                const postsRef = db.collection(`artifacts/${appId}/public/data/posts`);
                const query = postsRef.where('userId', '==', userId);
                
                try {
                    const snapshot = await query.get();
                    if (!snapshot.empty) {
                        const batch = db.batch();
                        snapshot.forEach(doc => {
                            batch.update(doc.ref, { userName: newUserName, userHandle: newUserHandle });
                        });
                        await batch.commit();
                        console.log(`Updated ${snapshot.size} posts for user ${userId}.`);
                    }
                } catch (error) {
                    console.error("Failed to update user's posts info:", error);
                }
            };


            /**
             * ユーザーIDの重複をチェックする関数
             * @param {string} username - チェックするユーザーID
             * @returns {Promise<boolean>} 重複している場合はtrue、そうでない場合はfalse
             */
            async function checkUsernameExists(username) {
                const usersRef = db.collection(`artifacts/${appId}/public/data/users`);
                // We also need to check that it's not the current user's own username.
                const query = usersRef.where('username', '==', username).where(firebase.firestore.FieldPath.documentId(), '!=', userId);
                try {
                    const snapshot = await query.get();
                    return !snapshot.empty;
                } catch (error) {
                    console.error("ユーザーIDの重複チェックに失敗しました:", error);
                    return true; // エラー時は安全側に倒し、重複ありと見なす
                }
            };

            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', async () => {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        showMessage('Googleのログインページに移動します...', 'info');
                        await auth.signInWithRedirect(provider);
                        // After redirect, auth.getRedirectResult() and onAuthStateChanged will handle the result.
                    } catch (error) {
                        console.error("Google認証に失敗しました:", error);
                        showMessage(`Google認証に失敗しました: ${error.message}`, 'error');
                    }
                });
            }

            // Email/Password Auth listeners
            if (emailLoginBtn) {
                emailLoginBtn.addEventListener('click', async () => {
                    const email = emailInput.value.trim();
                    const password = passwordInput.value;
                    emailError.textContent = '';
                    emailError.classList.add('hidden');

                    if (!email || !password) {
                        emailError.textContent = 'メールアドレスとパスワードを入力してください。';
                        emailError.classList.remove('hidden');
                        return;
                    }

                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                        // ログイン成功後、モーダルを閉じる
                        nameInputModal.classList.remove('active');
                        showMessage('ログインしました！', 'success');
                    } catch (error) {
                        emailError.textContent = getFirebaseAuthErrorMessage(error);
                        emailError.classList.remove('hidden');
                    }
                });
            }

            if (emailSignupBtn) {
                emailSignupBtn.addEventListener('click', async () => {
                    const email = emailInput.value.trim();
                    const password = passwordInput.value;
                    emailError.textContent = '';
                    emailError.classList.add('hidden');
                    
                    if (!email || !password) {
                        emailError.textContent = 'メールアドレスとパスワードを入力してください。';
                        emailError.classList.remove('hidden');
                        return;
                    }
                    if (password.length < 6) {
                        emailError.textContent = 'パスワードは6文字以上で入力してください。';
                        emailError.classList.remove('hidden');
                        return;
                    }

                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        showMessage('新規登録が完了しました。続けて、表示される名前とIDを設定してください。', 'info');
                        passwordInput.value = '';
                    } catch (error) {
                        emailError.textContent = getFirebaseAuthErrorMessage(error);
                        emailError.classList.remove('hidden');
                    }
                });
            }

            if (changeNameBtn) {
                changeNameBtn.addEventListener('click', () => {
                    userNameInput.value = userName;

                    userIdInput.value = userHandle;
                    userPhotoURL = null;
                    userBio = "";
                    userIconPreview.src = '#';
                    nameInputModal.classList.add('active');
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await auth.signOut();
                        showMessage('ログアウトしました。', 'info');
                        userId = null;
                        userName = "匿名ユーザー";
                        userHandle = "";
                        userPhotoURL = null;
                        userBio = "";
                        currentUserFollowing = [];
                        updateUserInfoDisplay();
                        if (map) map.data.forEach(feature => map.data.remove(feature));
                        timelinePostsContainer.innerHTML = '<p class="text-gray-500 text-center">投稿がありません。</p>';
                    } catch (error) {
                        console.error("ログアウトに失敗しました:", error);
                        showMessage('ログアウトに失敗しました。', 'error');
                   }
                });
            }

            getLocationBtn.addEventListener('click', getCurrentLocation);

            postForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const postTextValue = postText.value.trim();
                const latitude = parseFloat(latitudeInput.value);
                const longitude = parseFloat(longitudeInput.value);
                const imageFile = postImageInput.files[0];

                if (postTextValue && (postTextValue.length < 10 || postTextValue.length > 500)) {
                    showMessage('メッセージは10文字以上500文字以下で入力してください。', 'error');
                    return;
                }

                if (!postTextValue && !imageFile) {
                    showMessage('メッセージまたは画像を入力してください。', 'error');
                    return;
                }
                if (isNaN(latitude) || isNaN(longitude)) {
                    showMessage('有効な緯度と経度を入力または選択してください。', 'error');
                    return;
                }

                if (!authReady || !userId) {
                    showMessage('認証が完了していません。しばらくお待ちください。', 'error');
                    console.warn("Firebase Authが準備できていないか、userIdがnullです。 Current userId:", userId, "authReady:", authReady);
                    return;
                }

                const hashtagRegex = /#([^\s#]+)/g;
                const hashtags = [...postTextValue.matchAll(hashtagRegex)].map(match => match[1]);


                if (userName === "匿名ユーザー" || !userHandle) {
                    nameInputModal.classList.add('active');
                    showMessage('投稿するにはユーザー名を設定してください。', 'info');
                    return;
                }
                const userDocRef = db.collection(`artifacts/${appId}/public/data/users`).doc(userId);
                const userDocSnap = await userDocRef.get();

                const likedPosts = JSON.parse(localStorage.getItem('likedPosts') || '[]');
                let imageUrl = null;
                if (imageFile) {
                    submitPostBtn.disabled = true;
                    selectImageBtn.disabled = true;
                    imageUrl = await uploadImage(imageFile);
                    submitPostBtn.disabled = false;
                    selectImageBtn.disabled = false;
                    if (!imageUrl) {
                        return;
                    }
                }

                const newPost = {
                    text: postTextValue,
                    latitude: latitude,
                    longitude: longitude,
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    userName: userName,
                    userHandle: userHandle,
                    likedBy: [],
                    imageUrl: imageUrl,
                    hashtags: hashtags
                };

                try {
                    await db.collection(`artifacts/${appId}/public/data/posts`).add(newPost);
                    postText.value = '';
                    postImageInput.value = '';
                    imagePreview.src = '#';
                    imagePreviewContainer.classList.add('hidden');
                    showMessage('投稿を送信しました！', 'success');
                    
                    const likedPosts = JSON.parse(localStorage.getItem('likedPosts') || '[]');
                // Add the post ID to the liked posts in localStorage
                if (!likedPosts.includes(newPost.id)) {
                   likedPosts.push(newPost.id);
                    saveLikedPostsForUser(likedPosts);
                    console.log(`Post ${newPost.id} liked and added to localStorage`);

                } }catch (e) {
                    console.error("Firestoreへの投稿エラー:", e);
                    showMessage('投稿に失敗しました。', 'error');
                }

            });

            if (openFormBtn) {
                openFormBtn.addEventListener('click', () => switchView('post'));
            }
           if (closeFormBtn) {
                closeFormBtn.addEventListener('click', () => {
                    postFormOverlay.classList.remove('active');
                    switchView('map');
                });
            }

            if (navMapBtn) {
                navMapBtn.addEventListener('click', () => switchView('map'));
           }
            if (navPostBtn) {
                navPostBtn.addEventListener('click', () => switchView('post'));
            }
            if (navTimelineBtn) { // Reusing timeline button for account
                navTimelineBtn.addEventListener('click', () => switchView('timeline', 'all'));
            }
            if (navAccountBtn) {
                navAccountBtn.addEventListener('click', () => switchView('account'));
            }

            if (window.innerWidth >= 768) {
                switchView('map');
            } else {
                switchView('map');
            }

            // Event delegation for dynamically created elements
            document.body.addEventListener('click', async (event) => {
                const target = event.target;

                // Like button
                const likeBtn = target.closest('.like-btn');
                if (likeBtn) {
                    const postId = likeBtn.dataset.postId;
                   const docRef = db.collection(`artifacts/${appId}/public/data/posts`).doc(postId);                
                    const docSnap = await docRef.get();
                    if (docSnap.exists) {
                        await toggleLike(postId, docSnap.data().likedBy || []);
                    }
                }

                // Delete button
                const deleteBtn = target.closest('.delete-btn');
                if (deleteBtn) {
                    showConfirmModal('本当にこの投稿を削除しますか？', deleteBtn.dataset.postId);
                }

                // Follow button
                const followBtn = target.closest('.follow-btn');
                if (followBtn) {
                    await toggleFollow(followBtn.dataset.targetUserId);
                }

                // User profile link
                const profileLink = target.closest('.user-profile-link');
                if (profileLink) {
                    await showUserProfile(profileLink.dataset.userId);
                }
            });

            // Timeline tabs event listener
            if (timelineTabs) {
                timelineTabs.addEventListener('click', (event) => {
                    if (event.target.matches('.timeline-tab-btn')) {
                        const tab = event.target.dataset.tab;
                        if (tab !== currentTimelineTab) {
                            currentTimelineTab = tab;
                            document.querySelectorAll('.timeline-tab-btn').forEach(btn => btn.classList.remove('active'));
                            event.target.classList.add('active');
                            fetchTimelinePosts(currentTimelineTab);
                        }
                    }
                });
            }

            if (saveAccountBtn) {
                saveAccountBtn.addEventListener('click', async () => {
                    const inputName = accountUserNameInput.value.trim();
                    const inputBio = accountBioInput.value.trim();
                    const iconFile = accountIconInput.files[0];

                    if (!inputName) {
                        showMessage('ユーザー名を入力してください。', 'error');
                        return;
                    }
                    
                    saveAccountBtn.disabled = true;
                    try {
                        let newPhotoURL = userPhotoURL;
                        if (iconFile) {
                            newPhotoURL = await uploadImage(iconFile, 'profile');
                        }
                        
                        const userDocRef = db.collection(`artifacts/${appId}/public/data/users`).doc(userId);
                        const userDataToUpdate = {
                            name: inputName,
                            bio: inputBio,
                            photoURL: newPhotoURL,
                            updatedAt: new Date().toISOString()
                        };
                        
                        await userDocRef.set(userDataToUpdate, { merge: true });

                        // Update global state and user's posts if name changed
                        if (userName !== inputName) await updatePostsUserInfo(userId, inputName, userHandle);
                        userName = inputName;
                        userPhotoURL = newPhotoURL;
                        userBio = inputBio;
                        
                        updateUserInfoDisplay();
                        showMessage('アカウント情報が更新されました！', 'success');
                    } catch (error) {
                        console.error("アカウント情報の更新に失敗しました:", error);
                        showMessage('アカウント情報の更新に失敗しました。', 'error');
                    } finally {
                        saveAccountBtn.disabled = false;
                    }
                });
            }

            // Profile modal listeners
            if(closeProfileBtn) {
                closeProfileBtn.addEventListener('click', () => userProfileModal.classList.add('hidden'));
           }
            if(userProfileModal) {
               userProfileModal.addEventListener('click', (e) => {
                    if(e.target === userProfileModal) userProfileModal.classList.add('hidden');
                });
            }

            nonLoginMenu.style.display = 'none';
            initDesktopTabs();
            fetchTrendingHashtags();
        }); // セミコロンを追加
        function createPostElement(post, context = 'timeline') {

            const postElement = document.createElement('div');
            postElement.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';

            const postDate = new Date(post.timestamp).toLocaleString();
            const escapedPostText = escapeHTML(post.text || '');
            const escapedPostUserName = escapeHTML(post.userName || '名無し');
            const hashtagRegex = /#([^\s#]+)/g;
            const linkedPostText = escapedPostText.replace(hashtagRegex, '<a href="#" onclick="filterByHashtag(event, \'$1\')" class="text-blue-500 hover:underline">#$1</a>');
            const escapedUserHandle = escapeHTML(post.userHandle || '');

            const isFollowing = userId && post.userId !== userId && currentUserFollowing.includes(post.userId);
            const followButtonClass = isFollowing ? 'bg-gray-500 hover:bg-gray-600' : 'bg-blue-500 hover:bg-blue-600';
            const followButtonText = isFollowing ? 'フォロー中' : 'フォロー';
            const followButtonHtml = userId && post.userId !== userId ? `
                <button class="follow-btn text-white py-1 px-2 rounded-md text-xs transition duration-150 ease-in-out ${followButtonClass}" data-target-user-id="${post.userId}">
                    ${followButtonText}
                </button>
            ` : '';

            const isLiked = post.likedBy && userId && post.likedBy.includes(userId);

              postElement.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <button class="user-profile-link font-bold text-gray-800 text-sm hover:underline" data-user-id="${post.userId}">${escapedPostUserName}</button>
                        ${context === 'timeline' ? followButtonHtml : ''}
                    </div>
                    <span class="text-gray-500 text-xs">${postDate}</span>
                </div>
                ${post.imageUrl ? `<img src="${escapeHTML(post.imageUrl)}" alt="投稿画像" class="my-2 rounded-md max-w-full h-auto" style="max-height: 200px; object-fit: contain;">` : ''}
                    <p class="text-gray-700 text-sm whitespace-pre-wrap">${linkedPostText}</p>
                <div class="flex items-center mt-3">
                    <button class="like-btn flex items-center space-x-1 text-xs transition duration-150 ease-in-out" data-post-id="${post.id}">
                        <svg class="w-4 h-4 ${isLiked ? 'text-pink-500' : 'text-gray-400'}" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                        <span class="${isLiked ? 'text-pink-600' : 'text-gray-500'}">${post.likedBy ? post.likedBy.length : 0}</span>
                    </button>
                        ${userId && post.userId === userId ? `
                        <button class="delete-btn bg-red-500 text-white py-1 px-2 rounded-md text-xs hover:bg-red-600 transition duration-150 ease-in-out ml-auto" data-post-id="${post.id}">
                            削除
                        </button>
                    ` : ''}
                </div>
            `;
            return postElement;
          }
        async function showUserProfile(targetUserId) {
            if (!targetUserId || !db) return;
            
            userProfileModal.classList.remove('hidden');

            const userDoc = await db.collection(`artifacts/${appId}/public/data/users`).doc(targetUserId).get();
            if (!userDoc.exists) {
                profileUserName.textContent = "不明なユーザー";
                profileUserHandle.textContent = "";
                profileBio.textContent =  'データがありません';
                profileAvatar.src = "";
                return;
            }

            const userData = userDoc.data();
            profileUserName.textContent = userData.name;
            profileUserHandle.textContent = userData.username;
            profileBio.textContent = userData.bio || '';
            profileFollowingCount.textContent = userData.followingCount || 0;
            profileFollowerCount.textContent = userData.followerCount || 0;
            profileAvatar.src = userData.photoURL || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

            if (userId && userId !== targetUserId) {
                profileFollowBtn.dataset.targetUserId = targetUserId;
                if (currentUserFollowing.includes(targetUserId)) {
                    profileFollowBtn.textContent = "フォロー中";
                    profileFollowBtn.classList.replace('bg-blue-500', 'bg-gray-500');
                } else {
                    profileFollowBtn.textContent = "フォロー";
                    profileFollowBtn.classList.replace('bg-gray-500', 'bg-blue-500');
                }
                profileFollowBtn.classList.remove('hidden');
            } else {
                profileFollowBtn.classList.add('hidden');
            }
            
            profilePostsContainer.innerHTML = '<p class="text-gray-500">投稿を読み込み中...</p>';
            const postsQuery = db.collection(`artifacts/${appId}/public/data/posts`)
                .where('userId', '==', targetUserId)
                .orderBy('timestamp', 'desc')
                .limit(20);

            const postsSnapshot = await postsQuery.get();
            profilePostsContainer.innerHTML = '';
            if (postsSnapshot.empty) {
                profilePostsContainer.innerHTML = '<p class="text-gray-500">このユーザーの投稿はまだありません。</p>';
            } else {
                postsSnapshot.forEach(doc => {
                    const post = { ...doc.data(), id: doc.id };
                    const postElement = createPostElement(post, 'profile');
                    profilePostsContainer.appendChild(postElement);
                });
            }
        }
        function initDesktopTabs() {
            const tabTimeline = document.getElementById('tab-timeline');
            const tabPost = document.getElementById('tab-post');
            const tabAccount = document.getElementById('tab-account');
            const postFormOverlay = document.getElementById('post-form-overlay');
            const timelineContainer = document.getElementById('timeline-container');
            const userProfileView = document.getElementById('user-profile-view');
            const userInfoDisplay = document.getElementById('user-info-display');
            const rightSidebar = document.getElementById('right-sidebar');
            const accountMenu = document.getElementById('account-menu');
            const mainContentWrapper = document.getElementById('main-content-wrapper'); // main-contentを囲むラッパー

            // すべてのコンテンツを非表示にする関数
            const hideAll = () => {
                postFormOverlay.style.display = 'none';
                // ハッシュタグによるフィルタリング機能 (UIの骨子)
                function filterByHashtag(event, hashtag) {
                    event.preventDefault(); // リンクのデフォルト動作を防ぐ
                    

                    // 実際のフィルタリングロジックをここに実装します。
                    // 1. タイムライン表示に切り替え
                    switchView('timeline');

                    // 2. タイムラインの投稿をフィルタリングして表示
                    fetchTimelinePosts('hashtag', hashtag);

                    showMessage(`ハッシュタグ「#${hashtag}」でフィルタリングします。`, 'info');
                    console.log(`Filtering by hashtag: #${hashtag}`);                    
                }

                  window.filterByHashtag = filterByHashtag;

              async function fetchTimelinePosts(filter = 'all', hashtag = null) {
                if (!authReady) {
                  console.warn("認証が完了していません。タイムライン投稿の取得を遅延します。");
                  return;
                }
                if (!db) {
                  console.error("Firestore database (db) is not initialized.");
                  showMessage("データベースが初期化されていません。", "error");
                  return;
                }

                let postsQuery = db.collection(`artifacts/${appId}/public/data/posts`);
                if (filter === 'hashtag' && hashtag) {
                    postsQuery = postsQuery.where('hashtags', 'array-contains', hashtag);
                }

                // トレンドのハッシュタグを取得して表示する関数
                async function fetchTrendingHashtags() {
                    if (!db) return;
                    const trendingHashtagsList = document.getElementById('trending-hashtags-list');
                    if (!trendingHashtagsList) return;

                    trendingHashtagsList.innerHTML = '<p class="text-sm text-gray-500">トレンドを読み込み中...</p>';

                    try {
                        // 本格的な実装ではCloud Functionで集計した結果を取得します。
                        // ここではデモとして、直近50件の投稿から簡易的にトレンドを集計します。
                        const postsSnapshot = await db.collection(`artifacts/${appId}/public/data/posts`)
                                                      .orderBy('timestamp', 'desc')
                                                    .limit(50)
                                                    .get();
                        
                        const hashtagCounts = {};
                        postsSnapshot.forEach(doc => {
                            const post = doc.data();
                            if (post.hashtags && Array.isArray(post.hashtags)) {
                                post.hashtags.forEach(tag => {
                                    hashtagCounts[tag] = (hashtagCounts[tag] || 0) + 1;
                                });
                            }
                        });

                        const sortedHashtags = Object.entries(hashtagCounts)
                                                    .sort(([,a],[,b]) => b - a)
                                                    .slice(0, 5); // 上位5件を表示
                        
                        renderTrendingHashtags(sortedHashtags);

                    } catch (error) {
                        console.error("トレンドのハッシュタグ取得エラー:", error);
                        trendingHashtagsList.innerHTML = '<p class="text-sm text-gray-500">トレンドの取得に失敗しました。</p>';
                    }
                }

                function renderTrendingHashtags(hashtags) {
                const trendingHashtagsList = document.getElementById('trending-hashtags-list');
                    trendingHashtagsList.innerHTML = '';

                    if (hashtags.length === 0) {
                        trendingHashtagsList.innerHTML = '<p class="text-sm text-gray-500">トレンドはありません。</p>';
                        return;
                    }
                }
                timelineContainer.style.display = 'none';
                userProfileView.classList.add('hidden');
                rightSidebar.style.display = 'none';
                accountMenu.style.display = 'none';
                userInfoDisplay.classList.add('hidden'); // ユーザー情報表示を隠す
                document.querySelectorAll('#desktop-tabs button').forEach(btn => btn.classList.remove('active'));
            };
        }
    }
        
        function getLikedPostsKey() {
            return `likedPosts_${userId || 'anonymous'}`;
        }

        function getLikedPostsForUser() {
            return JSON.parse(localStorage.getItem(getLikedPostsKey()) || '[]');
        }

        function saveLikedPostsForUser(likedPosts) {
            localStorage.setItem(getLikedPostsKey(), JSON.stringify(likedPosts));
        }

        /**
         * ローカルストレージにいいねした投稿のリストを保存する
         */
        function saveLikedPostsToLocalStorage(likedPosts) {
            localStorage.setItem('likedPosts', JSON.stringify(likedPosts));
            console.log("Saved liked posts to localStorage:", likedPosts);
        }

        /**
         * ローカルストレージからいいねした投稿のリストをクリアする
         */
        function clearLikedPostsFromLocalStorage() {
            localStorage.removeItem('likedPosts');
            console.log("Cleared liked posts from localStorage.");
        }

        // Call loadLikedPostsFromLocalStorage on page load (within DOMContentLoaded)
        
        

        // Update the toggleLike function to use local storage
       async function toggleLike(postId, currentLikedBy) {
           if (!db || !userId) {
                showMessage('認証またはデータベースが準備できていません。', 'error');
                return;
            }

            const postRef = db.collection(`artifacts/${appId}/public/data/posts`).doc(postId);
            const batch = db.batch();
            const likedPosts = JSON.parse(localStorage.getItem('likedPosts') || '[]');
            if (likedPosts.includes(postId)) {
                batch.update(postRef, { likedBy: firebase.firestore.FieldValue.arrayRemove(userId) });
               localStorage.setItem('likedPosts', JSON.stringify(likedPosts.filter(id => id !== postId)));
            } else {
                batch.update(postRef, { likedBy: firebase.firestore.FieldValue.arrayUnion(userId) });
               localStorage.setItem('likedPosts', JSON.stringify([...likedPosts, postId]));
           }
           await batch.commit();
        }
    </script>
    <!-- Google Maps JavaScript APIの読み込み -->
    <!-- callback=initGoogleMap で指定された関数は、グローバルスコープに存在する必要があります。 -->
    <!-- %%GOOGLE_MAPS_API_KEY%% はCloudflare Pagesのビルド時に環境変数で置き換えられます。 -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=%%GOOGLE_MAPS_API_KEY%%&callback=initGoogleMap">
    </script>
</body>

</html>